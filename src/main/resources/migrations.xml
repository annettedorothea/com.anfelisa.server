<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

	<changeSet id="001" author="annette">
		<createTable tableName="timeline">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="type" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="method" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="time" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="data" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="uuid" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>
		<createTable tableName="errortimeline">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="type" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="method" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="time" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="data" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="uuid" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>
	<changeSet id="002" author="annette">
		<createTable tableName="user">
			<column name="username" type="character varying">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="password" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="prename" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="email" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="role" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="emailconfirmed" type="boolean">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="loginlog">
			<column name="loginlogid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="username" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="date" type="timestamp with time zone">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="box">
			<column name="boxid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="username" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="course">
			<column name="courseid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="description" type="character varying">
				<constraints />
			</column>
			<column name="sequence" type="integer">
				<constraints />
			</column>
			<column name="ispublic" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="author" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="studentofcourse">
			<column name="username" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="courseid" type="integer">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="boxofcourse">
			<column name="boxid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="courseid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="autoadd" type="boolean">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="lesson">
			<column name="lessonid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="description" type="character varying">
				<constraints />
			</column>
			<column name="sequence" type="integer">
				<constraints />
			</column>
			<column name="courseid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="author" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="test">
			<column name="testid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="sequence" type="integer">
				<constraints />
			</column>
			<column name="lessonid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="html" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="author" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="result">
			<column name="resultid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="username" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="testid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="date" type="timestamp with time zone">
				<constraints nullable="false" />
			</column>
			<column name="json" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="points" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="maxpoints" type="integer">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="card">
			<column name="cardid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="content" type="character varying">
				<constraints />
			</column>
			<column name="testid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="contenthash" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="maxpoints" type="integer">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="scheduledcard">
			<column name="scheduledcardid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="cardid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="ef" type="numeric">
				<constraints nullable="false" />
			</column>
			<column name="interval" type="integer">
				<constraints />
			</column>
			<column name="n" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="count" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="scheduleddate" type="timestamp with time zone">
				<constraints nullable="false" />
			</column>
			<column name="boxid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="lastquality" type="integer">
				<constraints />
			</column>
			<column name="timestamp" type="timestamp with time zone">
				<constraints nullable="false" />
			</column>
			<column name="removed" type="boolean">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="scoredcard">
			<column name="scoredcardid" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="cardid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="scheduleddateofscored" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="boxid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="quality" type="integer">
				<constraints />
			</column>
			<column name="timestamp" type="timestamp with time zone">
				<constraints nullable="false" />
			</column>
			<column name="points" type="integer">
				<constraints />
			</column>
			<column name="scheduledcardid" type="integer">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="003" author="annette">
		<insert tableName="user">
			<column name="username" value="Annette" />
			<column name="password" value="00161e7f79e404bad9cc8f53c0f663f2" />
			<column name="name" value="Pohl" />
			<column name="prename" value="Annette" />
			<column name="email" value="annette_pohl@web.de" />
			<column name="role" value="ADMIN" />
			<column name="emailconfirmed" value="TRUE" />
		</insert>
	</changeSet>

	<changeSet id="004" author="annette">
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('box_boxid_seq', COALESCE((SELECT MAX(boxid)+1 FROM
			public.box), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('course_courseid_seq', COALESCE((SELECT MAX(courseid)+1 FROM
			public.course), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('errortimeline_id_seq', COALESCE((SELECT MAX(id)+1 FROM
			public.errortimeline), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('lesson_lessonid_seq', COALESCE((SELECT MAX(lessonid)+1 FROM
			public.lesson), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('loginlog_loginlogid_seq', COALESCE((SELECT MAX(loginlogid)+1
			FROM public.loginlog), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('result_resultid_seq', COALESCE((SELECT MAX(resultid)+1 FROM
			public.result), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('scheduledcard_scheduledcardid_seq', COALESCE((SELECT
			MAX(scheduledcardid)+1 FROM public.scheduledcard), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('scoredcard_scoredcardid_seq', COALESCE((SELECT
			MAX(scoredcardid)+1 FROM public.scoredcard), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('test_testid_seq', COALESCE((SELECT MAX(testid)+1 FROM
			public.test), 1), false)
		</sql>
		<sql splitStatements="true" stripComments="true">
			SELECT
			setval('timeline_id_seq', COALESCE((SELECT MAX(id)+1 FROM
			public.timeline), 1), false)
		</sql>
	</changeSet>

	<changeSet id="005" author="annette">
		<createTable tableName="scenario">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="description" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="data" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="createddatetime" type="timestamp with time zone">
				<constraints />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="006" author="annette">
		<createTable tableName="bug">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="description" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="data" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="reporter" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="resolved" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="createddatetime" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="updateddatetime" type="timestamp with time zone">
				<constraints />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="007" author="annette">
		<dropTable tableName="bug" />
		<dropTable tableName="scenario" />

		<createTable tableName="scenario">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="description" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="timeline" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="creator" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="createddatetime" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="updateddatetime" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="serverversion" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="clientversion" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="device" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="bug">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="description" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="timeline" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="reporter" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="resolved" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="createddatetime" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="updateddatetime" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="serverversion" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="clientversion" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="device" type="character varying">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="scenarioresult">
			<column name="id" type="serial">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="scenarioid" type="integer">
				<constraints nullable="false" references="scenario(id)"
					deleteCascade="true" foreignKeyName="fk_scenarioresult_scenario" />
			</column>
			<column name="description" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="timeline" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="executor" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="createddatetime" type="timestamp with time zone">
				<constraints />
			</column>
			<column name="serverversion" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="clientversion" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="device" type="character varying">
				<constraints nullable="false" />
			</column>
			<column name="result" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="e2e" type="boolean">
				<constraints nullable="false" />
			</column>
		</createTable>


	</changeSet>

	<changeSet id="008" author="annette">
		<addForeignKeyConstraint baseColumnNames="courseid"
			baseTableName="lesson" constraintName="fk_lesson_courseid"
			referencedColumnNames="courseid" referencedTableName="course"
			onDelete="CASCADE" />
		<addForeignKeyConstraint baseColumnNames="lessonid"
			baseTableName="test" constraintName="fk_test_lessonid"
			referencedColumnNames="lessonid" referencedTableName="lesson"
			onDelete="CASCADE" />
		<addForeignKeyConstraint baseColumnNames="testid"
			baseTableName="result" constraintName="fk_result_testid"
			referencedColumnNames="testid" referencedTableName="test"
			onDelete="CASCADE" />
		<addForeignKeyConstraint baseColumnNames="testid"
			baseTableName="card" constraintName="fk_card_testid"
			referencedColumnNames="testid" referencedTableName="test"
			onDelete="CASCADE" />
		<addForeignKeyConstraint baseColumnNames="cardid"
			baseTableName="scoredcard" constraintName="fk_scoredcard_cardid"
			referencedColumnNames="cardid" referencedTableName="card"
			onDelete="CASCADE" />
		<addForeignKeyConstraint baseColumnNames="cardid"
			baseTableName="scheduledcard" constraintName="fk_scheduledcard_cardid"
			referencedColumnNames="cardid" referencedTableName="card"
			onDelete="CASCADE" />
	</changeSet>

	<changeSet id="009" author="annette">
		<addForeignKeyConstraint baseColumnNames="courseid"
			baseTableName="boxofcourse" constraintName="fk_boxofcourse_courseid"
			referencedColumnNames="courseid" referencedTableName="course"
			onDelete="CASCADE" />
		<addForeignKeyConstraint baseColumnNames="boxid"
			baseTableName="boxofcourse" constraintName="fk_boxofcourse_boxid"
			referencedColumnNames="boxid" referencedTableName="box"
			onDelete="CASCADE" />
	</changeSet>

	<changeSet id="010" author="annette">
		<dropTable tableName="scenarioresult" />
		<dropTable tableName="bug" />
		<dropTable tableName="scenario" />
	</changeSet>

	<changeSet id="011" author="annette">
		<sql splitStatements="true" stripComments="true">
			delete from timeline where name like '%SendRegistrationEmailEvent%';
		</sql>
		<sql splitStatements="true" stripComments="true">
			update timeline set name = 'com.anfelisa.user.events.CreateUserSuccessEvent' where name like '%UserCreated%';
			update timeline set name = 'com.anfelisa.user.events.LoginSuccessEvent' where name like '%UserLoggedIn%';
			update timeline set name = 'com.anfelisa.user.events.UpdateUserSuccessEvent' where name like '%UserUpdated%';
			update timeline set name = 'com.anfelisa.user.events.AddCoursesSuccessEvent' where name like '%CoursesAdded%';
			update timeline set name = 'com.anfelisa.user.events.RemoveCourseSuccessEvent' where name like '%CourseRemoved%';
			update timeline set name = 'com.anfelisa.user.events.UpdatePasswordSuccessEvent' where name like '%PasswordUpdated%';
			update timeline set name = 'com.anfelisa.user.events.ForgotPasswordOkEvent' where name like '%SendEmail%';
			update timeline set name = 'com.anfelisa.user.events.RegisterUserOkEvent' where name like '%UserRegistered%';
			update timeline set name = 'com.anfelisa.user.events.ConfirmEmailOkEvent' where name like '%EmailConfirmed%';
			update timeline set name = 'com.anfelisa.user.events.ChangeUserToPremiumOkEvent' where name like '%ChangeUserToPremium%';
			update timeline set name = 'com.anfelisa.user.events.ChangeUserToAuthorOkEvent' where name like '%ChangeUserToAuthor%';
			update timeline set name = 'com.anfelisa.user.events.ChangeUserToAdminOkEvent' where name like '%ChangeUserToAdmin%';
			
			update timeline set name = 'com.anfelisa.test.events.CreateTestCreatedEvent' where name like '%TestCreated%';
			update timeline set name = 'com.anfelisa.test.events.UpdateTestUpdatedEvent' where name like '%TestUpdated%';
			update timeline set name = 'com.anfelisa.test.events.DeleteTestDeletedEvent' where name like '%TestDeleted%';
			
			update timeline set name = 'com.anfelisa.result.events.CreateResultCreatedEvent' where name like '%ResultCreated%';
			update timeline set name = 'com.anfelisa.result.events.SaveResultSavedEvent' where name like '%ResultSaved%';

			update timeline set name = 'com.anfelisa.lesson.events.CreateLessonCreatedEvent' where name like '%LessonCreated%';
			update timeline set name = 'com.anfelisa.lesson.events.UpdateLessonUpdatedEvent' where name like '%LessonUpdated%';
			update timeline set name = 'com.anfelisa.lesson.events.DeleteLessonDeletedEvent' where name like '%LessonDeleted%';

			update timeline set name = 'com.anfelisa.course.events.CreateCourseCreatedEvent' where name like '%CourseCreated%';
			update timeline set name = 'com.anfelisa.course.events.AddStudentToCourseAddedEvent' where name like '%StudentAddedToCourse%';
			update timeline set name = 'com.anfelisa.course.events.UpdateCourseUpdatedEvent' where name like '%CourseUpdated%';
			update timeline set name = 'com.anfelisa.course.events.DeleteCourseDeletedEvent' where name like '%CourseDeleted%';

			update timeline set name = 'com.anfelisa.box.events.CreateBoxCreatedEvent' where name like '%BoxCreated%';
			update timeline set name = 'com.anfelisa.box.events.CreateCardCreatedEvent' where name like '%CardCreated%';
			update timeline set name = 'com.anfelisa.box.events.ImportCardImportedEvent' where name like '%CardImported%';
			update timeline set name = 'com.anfelisa.box.events.CreateScheduledCardCreatedEvent' where name like '%ScheduledCardCreated%';
			update timeline set name = 'com.anfelisa.box.events.CreateScoredCardCreatedEvent' where name like '%ScoredCardCreated%';
			update timeline set name = 'com.anfelisa.box.events.AddCourseToBoxAddedEvent' where name like '%CourseAddedToBox%';
			update timeline set name = 'com.anfelisa.box.events.UpdateBoxUpdatedEvent' where name like '%BoxUpdated%';
			update timeline set name = 'com.anfelisa.box.events.DeleteBoxDeletedEvent' where name like '%BoxDeleted%';
			update timeline set name = 'com.anfelisa.box.events.SaveBoxConfigSavedEvent' where name like '%BoxConfigSaved%';
			update timeline set name = 'com.anfelisa.box.events.ScoreCardScoredEvent' where name like '%CardScored%';
			update timeline set name = 'com.anfelisa.box.events.FillBoxWithCardsFillBoxWithCardsEvent' where name like '%FillBoxWithCards%';
			update timeline set name = 'com.anfelisa.box.events.DeleteCardDeletedEvent' where name like '%CardDeleted%';
			update timeline set name = 'com.anfelisa.box.events.RemoveCardFromBoxDeletedEvent' where name like '%CardRemovedFromBox%';
			update timeline set name = 'com.anfelisa.box.events.RecalculateScheduledCardsOkEvent' where name like '%RecalculateScheduledCards%';
		</sql>
		<addUniqueConstraint columnNames="type, uuid"
			tableName="timeline" />
		<addUniqueConstraint columnNames="type, uuid"
			tableName="errortimeline" />
	</changeSet>


</databaseChangeLog>
